---
createdAt: 2024/01/01
title: "[Sketch Match] 作成中のゲームについての進捗"
description: 作成中のお絵かき + 神経衰弱のオンラインパーティーゲームを紹介します。
tags: 
  - 個人開発
  - ゲーム
  - SketchMatch
# thumbnail:
#   url: thumbnail.webp
#   alt: 左側にモーダルが開かれている画面、右側にそのモーダルが閉じた画面のスクリーンショットが配置されていて、左側の画面にはAndroidの「戻る」ジェスチャーの実行中であることを示す「＜」マークがある。「＜」マークは丸で囲んで強調されており、そこから右の画面への矢印があり、モーダルを閉じる動作が表されている。
---

このサイトを作った主目的の一つ、個人開発で作っているものの進捗報告をします。
ブログでブログの話しかしていない状態だったので、ようやく意義が生じますね。

今回のテーマは、お絵描き + 神経衰弱のパーティーゲーム、`Sketch Match`についてです。
一応、一通り遊べるようにはなってるので、動画を撮ってみました (一人でやってます)。現状はこんな感じ！

```youtube
VwWhr-KX-4E
```

## コンセプト

[Gartic Phone](https://garticphone.com/)とか[ピクトセンス](https://pictsense.com)みたいな、みんなで絵を書くゲームはなんだかんだ盛り上がるので、その辺の枠に滑り込もう！
というのが最初の取っ掛かりだったと思います。

その上で、なんやかんやあって神経衰弱を組み合わせました。
(ほぼ同じコンセプトのゲームがWeb上に存在していたようなのですが、現状遊べない状態にあるようなので気にしないことにしています。)

基本的な流れは↓のようになっています。

1. 各プレイヤーは表示されたお題の絵を描く
    * このとき、各お題はそれぞれ、２人のユーザーに出されてる (同じお題で描かれた絵が２つある状態になる)
2. みんなが描いた絵で神経衰弱をする
3. 正しいペア (同じお題で描かれた絵) を選べたらそのプレイヤーは１点獲得
4. ペアのうちどちらが上手かを投票を決め、絵が選ばれたプレイヤーは１点獲得

神経衰弱なので、全部の絵が表になるまで繰り返します。
同じお題でも全然違う絵になったりして、神経衰弱パートで「絵は覚えてるのにわかんない」みたいになったら面白いだろ！！なあ！！！という気持ちです。

## 技術スタック

### バックエンド

バックエンドは全部Firebaseに頼っていて、↓のサービスを利用しています。

* Firebase Realtime Database
* Cloud Functions for Firebase
* Cloud Storage for Firebase
* Firebase Hosting

基本的には、各プレイヤーでRealtimeDBを監視しておいて、「誰かの操作によってDB更新→それをトリガーに画面更新」を繰り返すことでゲームを実現しています。
ただ、特定の誰かの操作をトリガーにできない処理、例えば「全員が絵を書き終えたときに神経衰弱の盤面を作る処理」とかがあるので、そういうところでCloud Functionを使っています。
また、画像データを一時的に保持する必要もあるので、そのためにCloud Storageも使っています。

DB部分は、RealtimeDBの他にCloud Firestoreも選択肢にありましたが、リアルタイムに各プレイヤーの接続状況 (プレゼンス) を把握したいがためにRealtimeDBを使っています。
Firestoreには[`OnDisconnect`](https://firebase.google.com/docs/reference/js/v8/firebase.database.OnDisconnect)に相当するものがないんですよね。
ただ、データ更新の監視はどちらでも可能、かつ、`OnDisconnect`が不発になるときがあるので、プレゼンスのみRealtimeDBで管理するというのもありなのかもしれないです (`OnDisconnect`の設定後に他の`Reference` (DBの要素) いじるとそのハンドラが消える？とかだった気がする。ともかくそんなに使いやすくはない)。
[ドキュメント](https://firebase.google.com/docs/database/rtdb-vs-firestore?hl=ja)にある通りFirestoreのほうが新しくて、クエリや、そもそものDBとしてのパフォーマンスはいいらしいので。

あとは、[フロントエンド](#フロントエンド)はSSGしているので、その配信にFirebase Hostingも使っています。

### フロントエンド

基本的な技術スタックとしては↓のような感じです。

* Next.js (Page Router)
  * SSG機能 (`next export`) の出力をFirebase Hostingで配信
* Typescript
* CSS Modules

バックエンドからのデータは、`zod`でバリデーションして`jotai`で状態管理しています。

## 現状と計画

一応遊べるようになっているものの、悪意に無防備すぎるので、もう少しちゃんとしなければと思ったままやる気が消えている状態です。

毎月Googleに1円を払っています。ムカついてきたな。

趣味でやっていることなので当たり前ですが、EDoSみたいなことをされると、直に自分の財布にダメージが来ます。
こちらに不利益があるだけ (お金の行き先は攻撃者でなくGoogleなので) のことをするようなやつ、この世にいないでほしいとは思いますが、
怖いのでそのあたりはしっかりしてから公開したいですね。
